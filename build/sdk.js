function _nextTick(f){setTimeout(f,0)}var request=require("superagent"),debug=require("debug")("opd-sdk"),querystring=require("querystring"),validate=require("opd-validate"),_=require("underscore")._,defaultFrom="-9999-01-01",defaultTo="9999-12-31",client=function(options){options=options||{},this.host=options.host?options.host:"http://www.openplacedatabase.org",this.username=options.username,this.password=options.password};client.prototype.searchPlaces=function(search,options,callback){var params={s:search};_.isFunction(options)?callback=options:_.isObject(options)&&_.extend(params,options),this._get("/api/v0/search/places?"+querystring.stringify(params),callback)},client.prototype.get=function(id,callback){this._get("/api/v0/places/"+id,callback)},client.prototype.getMulti=function(ids,callback){if(!_.isArray(ids))throw new Error("ids must be an array of strings");this._get("/api/v0/places/"+ids.join(","),callback)},client.prototype.save=function(id,object,callback){if(!_.isString(id))throw new Error("id must be a string");if(!_.isObject(object))throw new Error("data must be an object");try{-1!==id.indexOf("/")?validate.geojson(object):validate.place(object),this._post("/api/v0/places/"+id,object,callback)}catch(e){callback(e)}},client.prototype.saveMulti=function(objects,callback){var errors={},hasErrors=!1;_.each(objects,function(object,id){if(!_.isString(id))throw new Error("id must be a string");if(!_.isObject(object))throw new Error("data must be an object");try{-1!==id.indexOf("/")?validate.geojson(object):validate.place(object),errors[id]=null}catch(e){errors[id]=e,hasErrors=!0}}),hasErrors&&callback(new Error("Some objects are invalid"),errors),this._post("/api/v0/places",objects,function(error,response){var ids={};_.each(response,function(data,id){ids[id]=200===data.status.code}),callback(error,ids)})},client.prototype.delete=function(id,callback){this._delete("/api/v0/places/"+id,callback)},client.prototype.deleteMulti=function(ids,callback){if(!_.isArray(ids))throw new Error("ids must be an array");this._delete("/api/v0/places/"+ids.join(","),function(error,response){var ids={};_.each(response,function(data,id){ids[id]=200===data.status.code}),callback(error,ids)})},client.prototype.getChanges=function(from,to,callback){this._get("/api/v0/changes?from="+from+"&to="+to,callback)},client.prototype._get=function(url,callback){this._request("GET",url,null,callback)},client.prototype._post=function(url,data,callback){this._request("POST",url,data,callback)},client.prototype._delete=function(url,callback){this._request("DELETE",url,null,callback)},client.prototype._request=function(method,url,data,callback){var r=request(method,this.host+url).auth(this.username,this.password);data&&r.send(data),r.end(function(error,response){var response=response||{},error=error||response.error||void 0,data=response.body&&response.body.data?response.body.data:void 0;error&&(debug(url),debug(response.status),debug(response.data||response.text)),_nextTick(function(){callback(error,data)})})},module.exports={createClient:function(options){return new client(options)}};